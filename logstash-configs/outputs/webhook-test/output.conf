# Webhook Test Output
# Sends all parsed events to a webhook endpoint for testing
#
# Environment Variables:
#   WEBHOOK_URL - Full webhook URL (required)

output {
    # Suricata IDS events
    if "suricata" in [tags] {
        http {
            id => "webhook-suricata"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "suricata"
                "host" => "%{gw_hostname}"
                "event" => "%{suricataData}"
                "source" => "avx-ids"
                "time" => "%{unix_time}"
            }
        }
    }

    # L7 DCF / MITM events
    else if "mitm" in [tags] {
        http {
            id => "webhook-mitm"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "mitm"
                "host" => "%{gw_hostname}"
                "event" => "%{[@metadata][payload]}"
                "source" => "avx-l7-fw"
                "time" => "%{unix_time}"
            }
        }
    }

    # L4 Microseg events
    else if "microseg" in [tags] {
        http {
            id => "webhook-microseg"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "microseg"
                "host" => "%{gw_hostname}"
                "event" => {
                    "proto" => "%{proto}"
                    "action" => "%{action}"
                    "src_ip" => "%{src_ip}"
                    "src_port" => "%{src_port}"
                    "dst_ip" => "%{dst_ip}"
                    "dst_port" => "%{dst_port}"
                    "enforced" => "%{enforced}"
                    "uuid" => "%{uuid}"
                    "gw_ip" => "%{gw_ip}"
                    "src_mac" => "%{src_mac}"
                    "dst_mac" => "%{dst_mac}"
                    "ip_size" => "%{ip_size}"
                    "session_id" => "%{session_id}"
                    "session_event" => "%{session_event}"
                    "session_event_type" => "%{session_event_type}"
                    "session_end_reason" => "%{session_end_reason}"
                    "session_end_reason_text" => "%{session_end_reason_text}"
                    "session_pkt_cnt" => "%{session_pkt_cnt}"
                    "session_byte_cnt" => "%{session_byte_cnt}"
                    "session_dur" => "%{session_dur}"
                }
                "source" => "avx-l4-fw"
                "time" => "%{unix_time}"
            }
        }
    }

    # FQDN Firewall events
    else if "fqdn" in [tags] {
        http {
            id => "webhook-fqdn"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "fqdn"
                "host" => "%{gateway}"
                "event" => {
                    "sip" => "%{sip}"
                    "dip" => "%{dip}"
                    "gateway" => "%{gateway}"
                    "state" => "%{state}"
                    "hostname" => "%{hostname}"
                    "rule" => "%{rule}"
                }
                "source" => "avx-fqdn"
                "time" => "%{unix_time}"
            }
        }
    }

    # Controller CMD/API events
    else if "cmd" in [tags] {
        http {
            id => "webhook-cmd"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "cmd"
                "host" => "%{gw_hostname}"
                "event" => {
                    "action" => "%{action}"
                    "args" => "%{args}"
                    "result" => "%{result}"
                    "reason" => "%{reason}"
                    "username" => "%{username}"
                }
                "source" => "avx-cmd"
                "time" => "%{unix_time}"
            }
        }
    }

    # Gateway network statistics
    else if "gw_net_stats" in [tags] {
        http {
            id => "webhook-gw-net-stats"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "gw_net_stats"
                "host" => "%{gateway}"
                "event" => {
                    "gateway" => "%{gateway}"
                    "public_ip" => "%{public_ip}"
                    "private_ip" => "%{private_ip}"
                    "interface" => "%{interface}"
                    "total_rx_rate" => "%{total_rx_rate}"
                    "total_tx_rate" => "%{total_tx_rate}"
                }
                "source" => "avx-gw-net-stats"
                "time" => "%{unix_time}"
            }
        }
    }

    # Gateway system statistics - uses pre-built HEC payload for proper JSON serialization
    else if "gw_sys_stats" in [tags] {
        http {
            id => "webhook-gw-sys-stats"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "message"
            content_type => "application/json"
            message => "%{[@metadata][sys_stats_hec_payload]}"
        }
    }

    # Tunnel status changes
    else if "tunnel_status" in [tags] {
        http {
            id => "webhook-tunnel-status"
            http_method => "post"
            url => "${WEBHOOK_URL}"
            format => "json"
            mapping => {
                "type" => "tunnel_status"
                "host" => "%{gateway}"
                "event" => {
                    "src_gw" => "%{src_gw}"
                    "dst_gw" => "%{dst_gw}"
                    "old_state" => "%{old_state}"
                    "new_state" => "%{new_state}"
                }
                "source" => "avx-tunnel-status"
                "time" => "%{unix_time}"
            }
        }
    }
}
