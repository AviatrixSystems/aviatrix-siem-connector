# Splunk HTTP Event Collector Output
# Routes events to Splunk based on tags with appropriate source types
#
# Environment Variables:
#   SPLUNK_ADDRESS  - Splunk HEC hostname/IP (required)
#   SPLUNK_PORT     - HEC port (default: 8088)
#   SPLUNK_HEC_AUTH - HEC authentication token (required)

output {
    # Suricata IDS events - flattened structure with alert.* fields at top level
    # Uses pre-built HEC payload to ensure event is a proper JSON object
    if "suricata" in [tags] {
        http {
            id => "splunk-suricata"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "message"
            content_type => "application/json"
            message => "%{[@metadata][suricata_hec_payload]}"
        }
    }

    # L7 DCF / MITM events
    else if "mitm" in [tags] {
        http {
            id => "splunk-mitm"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:firewall:l7"
                "source" => "avx-l7-fw"
                "host" => "%{gw_hostname}"
                "time" => "%{unix_time}"
                "event" => "%{[@metadata][payload]}"
            }
        }
    }

    # L4 Microseg events
    else if "microseg" in [tags] {
        http {
            id => "splunk-microseg"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:firewall:l4"
                "source" => "avx-l4-fw"
                "host" => "%{gw_hostname}"
                "time" => "%{unix_time}"
                "event" => {
                    "proto" => "%{proto}"
                    "action" => "%{action}"
                    "src_ip" => "%{src_ip}"
                    "src_port" => "%{src_port}"
                    "dst_ip" => "%{dst_ip}"
                    "dst_port" => "%{dst_port}"
                    "enforced" => "%{enforced}"
                    "uuid" => "%{uuid}"
                    "gw_ip" => "%{gw_ip}"
                    "src_mac" => "%{src_mac}"
                    "dst_mac" => "%{dst_mac}"
                    "ip_size" => "%{ip_size}"
                    "session_id" => "%{session_id}"
                    "session_event" => "%{session_event}"
                    "session_end_reason" => "%{session_end_reason}"
                    "session_pkt_cnt" => "%{session_pkt_cnt}"
                    "session_byte_cnt" => "%{session_byte_cnt}"
                    "session_dur" => "%{session_dur}"
                    "syslog" => "%{message}"
                    "timestamp" => "%{unix_time}"
                }
            }
        }
    }

    # FQDN Firewall events
    else if "fqdn" in [tags] {
        http {
            id => "splunk-fqdn"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:firewall:fqdn"
                "source" => "avx-fqdn"
                "host" => "%{gateway}"
                "time" => "%{unix_time}"
                "event" => {
                    "sip" => "%{sip}"
                    "dip" => "%{dip}"
                    "gateway" => "%{gateway}"
                    "state" => "%{state}"
                    "hostname" => "%{hostname}"
                    "rule" => "%{rule}"
                    "syslog" => "%{message}"
                    "timestamp" => "%{unix_time}"
                }
            }
        }
    }

    # Controller CMD/API events
    else if "cmd" in [tags] {
        http {
            id => "splunk-cmd"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:controller:audit"
                "source" => "avx-cmd"
                "host" => "%{gw_hostname}"
                "time" => "%{unix_time}"
                "event" => {
                    "action" => "%{action}"
                    "args" => "%{args}"
                    "result" => "%{result}"
                    "reason" => "%{reason}"
                    "username" => "%{username}"
                    "syslog" => "%{message}"
                    "timestamp" => "%{unix_time}"
                }
            }
        }
    }

    # Gateway network statistics
    else if "gw_net_stats" in [tags] {
        http {
            id => "splunk-gw-net-stats"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:gateway:network"
                "source" => "avx-gw-net-stats"
                "host" => "%{gateway}"
                "time" => "%{unix_time}"
                "event" => {
                    "gateway" => "%{gateway}"
                    "public_ip" => "%{public_ip}"
                    "private_ip" => "%{private_ip}"
                    "interface" => "%{interface}"
                    "total_rx_rate" => "%{total_rx_rate}"
                    "total_tx_rate" => "%{total_tx_rate}"
                    "total_rx_tx_rate" => "%{total_rx_tx_rate}"
                    "total_rx_cum" => "%{total_rx_cum}"
                    "total_tx_cum" => "%{total_tx_cum}"
                    "total_rx_tx_cum" => "%{total_rx_tx_cum}"
                    "syslog" => "%{message}"
                }
            }
        }
    }

    # Gateway system statistics
    else if "gw_sys_stats" in [tags] {
        http {
            id => "splunk-gw-sys-stats"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:gateway:system"
                "source" => "avx-gw-sys-stats"
                "host" => "%{gateway}"
                "time" => "%{unix_time}"
                "event" => {
                    "gateway" => "%{gateway}"
                    "cpu_idle" => "%{cpu_idle}"
                    "memory_free" => "%{memory_free}"
                    "memory_available" => "%{memory_available}"
                    "memory_total" => "%{memory_total}"
                    "disk_total" => "%{disk_total}"
                    "disk_free" => "%{disk_free}"
                    "syslog" => "%{message}"
                }
            }
        }
    }

    # Tunnel status changes
    else if "tunnel_status" in [tags] {
        http {
            id => "splunk-tunnel-status"
            http_method => "post"
            url => "${SPLUNK_ADDRESS}:${SPLUNK_PORT:8088}/services/collector/event"
            headers => ["Authorization", "Splunk ${SPLUNK_HEC_AUTH}"]
            ssl_verification_mode => "none"
            format => "json"
            mapping => {
                "sourcetype" => "aviatrix:tunnel:status"
                "source" => "avx-tunnel-status"
                "host" => "%{gateway}"
                "time" => "%{unix_time}"
                "event" => {
                    "src_gw" => "%{src_gw}"
                    "dst_gw" => "%{dst_gw}"
                    "old_state" => "%{old_state}"
                    "new_state" => "%{new_state}"
                    "syslog" => "%{message}"
                }
            }
        }
    }
}
