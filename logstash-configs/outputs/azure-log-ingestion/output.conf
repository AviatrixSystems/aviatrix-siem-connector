# Azure Log Analytics / Sentinel Output (via Data Collection Rules)
# Uses the Microsoft Sentinel Log Analytics Logstash output plugin
#
# Supported Log Types:
#   - Suricata IDS alerts → Custom-AviatrixSuricata_CL
#   - L7 MITM/DCF (TLS inspection) → Custom-AviatrixMicroseg_CL
#   - L4 Microsegmentation → Custom-AviatrixMicroseg_CL
#
# Environment Variables:
#   client_app_id           - Azure AD application (service principal) ID
#   client_app_secret       - Azure AD application secret
#   tenant_id               - Azure AD tenant ID
#   data_collection_endpoint - Data Collection Endpoint URL
#   azure_dcr_suricata_id   - DCR immutable ID for Suricata logs
#   azure_stream_suricata   - Stream name for Suricata logs
#   azure_dcr_microseg_id   - DCR immutable ID for Microseg/MITM logs
#   azure_stream_microseg   - Stream name for Microseg/MITM logs
#   azure_cloud             - "AzureCloud", "AzureChinaCloud", or "AzureUSGovernment"

# Suricata-specific pre-processing for Azure
filter {
    if "suricata" in [tags] {
        mutate {
            id => "suricata-azure-cleanup"
            remove_field => ["message", "suricataData", "gw_hostname", "host", "port", "type", "event"]
        }

        # Add TimeGenerated field and flatten suricataDataJson for Azure
        ruby {
            id => "suricata-azure-flatten"
            code => "
                if event.get('suricataDataJson')
                    # Add TimeGenerated field required by Azure
                    event.set('TimeGenerated', event.get('@timestamp'))

                    # Flatten suricataDataJson into the event root
                    event.get('suricataDataJson').each { |k, v| event.set(k, v) }
                    event.remove('suricataDataJson')
                end
            "
        }
    }
}

# Microseg pre-processing for Azure
filter {
    if "microseg" in [tags] and "mitm" not in [tags] {
        # Add TimeGenerated field for Azure
        ruby {
            id => "microseg-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }
    }
}

# MITM/L7 DCF pre-processing for Azure
filter {
    if "mitm" in [tags] {
        # Add TimeGenerated field for Azure
        ruby {
            id => "mitm-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }
    }
}

output {
    # DEBUG: Output all events to stdout to verify processing
    stdout {
        id => "debug-stdout"
        codec => rubydebug {
            metadata => true
        }
    }

    # Suricata IDS events to Azure
    if "suricata" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-suricata"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_suricata_id}"
            dcr_stream_name => "${azure_stream_suricata}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L7 DCF / MITM events to Azure (TLS inspection)
    # MITM events are also tagged with "microseg" so they'll go to both outputs
    else if "mitm" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-mitm"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_microseg_id}"
            dcr_stream_name => "${azure_stream_microseg}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L4 Microseg events to Azure
    else if "microseg" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-microseg"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_microseg_id}"
            dcr_stream_name => "${azure_stream_microseg}"
            azure_cloud => "${azure_cloud}"
        }
    }
}
