# Azure Log Analytics / Sentinel Output (via Data Collection Rules)
# Uses the Microsoft Sentinel Log Analytics Logstash output plugin
#
# Supported Log Types:
#   - Suricata IDS alerts → Custom-AviatrixSuricata_CL
#   - L7 MITM/DCF (TLS inspection) → Custom-AviatrixMicroseg_CL
#   - L4 Microsegmentation → Custom-AviatrixMicroseg_CL
#   - Gateway Network Stats → Custom-AviatrixGwNetStats_CL
#   - Gateway System Stats → Custom-AviatrixGwSysStats_CL
#   - Controller CMD/API → Custom-AviatrixCmd_CL
#   - Tunnel Status Changes → Custom-AviatrixTunnelStatus_CL
#
# Environment Variables:
#   client_app_id               - Azure AD application (service principal) ID
#   client_app_secret           - Azure AD application secret
#   tenant_id                   - Azure AD tenant ID
#   data_collection_endpoint    - Data Collection Endpoint URL
#   azure_dcr_suricata_id       - DCR immutable ID for Suricata logs
#   azure_stream_suricata       - Stream name for Suricata logs
#   azure_dcr_microseg_id       - DCR immutable ID for Microseg/MITM logs
#   azure_stream_microseg       - Stream name for Microseg/MITM logs
#   azure_dcr_gw_net_stats_id   - DCR immutable ID for Gateway Network Stats
#   azure_stream_gw_net_stats   - Stream name for Gateway Network Stats
#   azure_dcr_gw_sys_stats_id   - DCR immutable ID for Gateway System Stats
#   azure_stream_gw_sys_stats   - Stream name for Gateway System Stats
#   azure_dcr_cmd_id            - DCR immutable ID for Controller CMD/API logs
#   azure_stream_cmd            - Stream name for Controller CMD/API logs
#   azure_dcr_tunnel_status_id  - DCR immutable ID for Tunnel Status logs
#   azure_stream_tunnel_status  - Stream name for Tunnel Status logs
#   azure_cloud                 - "AzureCloud", "AzureChinaCloud", or "AzureUSGovernment"

# Suricata-specific pre-processing for Azure
filter {
    if "suricata" in [tags] {
        mutate {
            id => "suricata-azure-cleanup"
            remove_field => ["message", "suricataData", "gw_hostname", "host", "port", "type", "event"]
        }

        # Add TimeGenerated field and flatten suricataDataJson for Azure
        ruby {
            id => "suricata-azure-flatten"
            code => "
                if event.get('suricataDataJson')
                    # Add TimeGenerated field required by Azure
                    event.set('TimeGenerated', event.get('@timestamp'))

                    # Flatten suricataDataJson into the event root
                    event.get('suricataDataJson').each { |k, v| event.set(k, v) }
                    event.remove('suricataDataJson')
                end
            "
        }
    }
}

# Microseg pre-processing for Azure
filter {
    if "microseg" in [tags] and "mitm" not in [tags] {
        ruby {
            id => "microseg-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "microseg-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri", "data_hex"]
        }
    }
}

# MITM/L7 DCF pre-processing for Azure
filter {
    if "mitm" in [tags] {
        ruby {
            id => "mitm-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "mitm-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

# Gateway Network Stats pre-processing for Azure
filter {
    if "gw_net_stats" in [tags] {
        ruby {
            id => "gw-net-stats-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "gw-net-stats-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

# Gateway System Stats pre-processing for Azure
filter {
    if "gw_sys_stats" in [tags] {
        ruby {
            id => "gw-sys-stats-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "gw-sys-stats-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri", "cpu_cores"]
        }
    }
}

# Controller CMD/API pre-processing for Azure
filter {
    if "cmd" in [tags] {
        ruby {
            id => "cmd-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "cmd-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

# Tunnel Status pre-processing for Azure
filter {
    if "tunnel_status" in [tags] {
        ruby {
            id => "tunnel-status-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "tunnel-status-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

output {
    # DEBUG: Output all events to stdout to verify processing
    stdout {
        id => "debug-stdout"
        codec => rubydebug {
            metadata => true
        }
    }

    # Suricata IDS events to Azure
    if "suricata" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-suricata"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_suricata_id}"
            dcr_stream_name => "${azure_stream_suricata}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L7 DCF / MITM events to Azure (TLS inspection)
    # MITM events are also tagged with "microseg" so they'll go to both outputs
    else if "mitm" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-mitm"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_microseg_id}"
            dcr_stream_name => "${azure_stream_microseg}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L4 Microseg events to Azure
    else if "microseg" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-microseg"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_microseg_id}"
            dcr_stream_name => "${azure_stream_microseg}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Gateway Network Stats to Azure
    else if "gw_net_stats" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-gw-net-stats"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_gw_net_stats_id}"
            dcr_stream_name => "${azure_stream_gw_net_stats}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Gateway System Stats to Azure
    else if "gw_sys_stats" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-gw-sys-stats"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_gw_sys_stats_id}"
            dcr_stream_name => "${azure_stream_gw_sys_stats}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Controller CMD/API events to Azure
    else if "cmd" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-cmd"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_cmd_id}"
            dcr_stream_name => "${azure_stream_cmd}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Tunnel Status events to Azure
    else if "tunnel_status" in [tags] {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-tunnel-status"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_tunnel_status_id}"
            dcr_stream_name => "${azure_stream_tunnel_status}"
            azure_cloud => "${azure_cloud}"
        }
    }
}
