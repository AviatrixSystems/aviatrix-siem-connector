# Azure Log Analytics / Sentinel Output (via Data Collection Rules)
# Uses the Microsoft Sentinel Log Analytics Logstash output plugin
#
# Security log types are ASIM-normalized:
#   - Suricata IDS alerts → Custom-AviatrixIDS_CL (ASIM NetworkSession, EventType=IDS)
#   - L7 MITM/DCF (TLS inspection) → Custom-AviatrixWebSession_CL (ASIM WebSession)
#   - L4 Microsegmentation → Custom-AviatrixNetworkSession_CL (ASIM NetworkSession)
#
# Non-security log types (unchanged):
#   - Gateway Network Stats → Custom-AviatrixGwNetStats_CL
#   - Gateway System Stats → Custom-AviatrixGwSysStats_CL
#   - Controller CMD/API → Custom-AviatrixCmd_CL
#   - Tunnel Status Changes → Custom-AviatrixTunnelStatus_CL
#
# Environment Variables:
#   client_app_id               - Azure AD application (service principal) ID
#   client_app_secret           - Azure AD application secret
#   tenant_id                   - Azure AD tenant ID
#   data_collection_endpoint    - Data Collection Endpoint URL
#   azure_dcr_ids_id            - DCR immutable ID for IDS (Suricata) logs
#   azure_stream_ids            - Stream name for IDS logs
#   azure_dcr_netsession_id     - DCR immutable ID for L4 Network Session logs
#   azure_stream_netsession     - Stream name for L4 Network Session logs
#   azure_dcr_websession_id     - DCR immutable ID for L7 Web Session logs
#   azure_stream_websession     - Stream name for L7 Web Session logs
#   azure_dcr_gw_net_stats_id   - DCR immutable ID for Gateway Network Stats
#   azure_stream_gw_net_stats   - Stream name for Gateway Network Stats
#   azure_dcr_gw_sys_stats_id   - DCR immutable ID for Gateway System Stats
#   azure_stream_gw_sys_stats   - Stream name for Gateway System Stats
#   azure_dcr_cmd_id            - DCR immutable ID for Controller CMD/API logs
#   azure_stream_cmd            - Stream name for Controller CMD/API logs
#   azure_dcr_tunnel_status_id  - DCR immutable ID for Tunnel Status logs
#   azure_stream_tunnel_status  - Stream name for Tunnel Status logs
#   azure_cloud                 - "AzureCloud", "AzureChinaCloud", or "AzureUSGovernment"
#   LOG_PROFILE                 - Which log types to forward (default: all)
#                                 - all: Forward all log types
#                                 - security: suricata, mitm, microseg, fqdn, cmd
#                                 - networking: gw_net_stats, gw_sys_stats, tunnel_status

# =============================================================================
# ASIM Field Mapping for Security Log Types
# =============================================================================
# These filters add ASIM-normalized fields alongside the original Aviatrix fields.
# Only applied when assembling for Azure output — Splunk configs never see this.

# Suricata IDS → ASIM NetworkSession (EventType=IDS)
filter {
    if "suricata" in [tags] {
        # Flatten suricataDataJson first (needed for ASIM mapping)
        ruby {
            id => "suricata-azure-flatten"
            code => "
                if event.get('suricataDataJson')
                    event.get('suricataDataJson').each { |k, v| event.set(k, v) }
                    event.remove('suricataDataJson')
                end
            "
        }

        # ASIM common fields
        mutate {
            id => "suricata-asim-common"
            add_field => {
                "EventVendor" => "Aviatrix"
                "EventProduct" => "Suricata IDS"
                "EventSchema" => "NetworkSession"
                "EventSchemaVersion" => "0.2.7"
                "EventType" => "IDS"
                "EventCount" => 1
            }
        }

        # ASIM field mapping via Ruby (action, severity, threat fields, flow fields)
        ruby {
            id => "suricata-asim-mapping"
            code => "
                event.set('TimeGenerated', event.get('@timestamp'))
                event.set('EventStartTime', event.get('@timestamp'))
                event.set('EventEndTime', event.get('@timestamp'))

                # Network addressing — Suricata uses dest_ip/dest_port
                event.set('SrcIpAddr', event.get('src_ip')) if event.get('src_ip')
                event.set('DstIpAddr', event.get('dest_ip')) if event.get('dest_ip')
                event.set('SrcPortNumber', event.get('src_port')) if event.get('src_port')
                event.set('DstPortNumber', event.get('dest_port')) if event.get('dest_port')
                event.set('NetworkProtocol', event.get('proto')) if event.get('proto')
                event.set('DvcInboundInterface', event.get('in_iface')) if event.get('in_iface')

                # App protocol (uppercase)
                if event.get('app_proto')
                    event.set('NetworkApplicationProtocol', event.get('app_proto').to_s.upcase)
                end

                # Flow session ID
                event.set('NetworkSessionId', event.get('flow_id').to_s) if event.get('flow_id')

                # DvcAction mapping
                alert = event.get('[alert]') || {}
                action = alert['action'].to_s.downcase rescue ''
                original_action = alert['action'].to_s rescue ''
                event.set('DvcOriginalAction', original_action)
                case action
                when 'allowed'
                    event.set('DvcAction', 'Allow')
                    event.set('EventResult', 'Success')
                when 'blocked'
                    event.set('DvcAction', 'Drop')
                    event.set('EventResult', 'Failure')
                else
                    event.set('DvcAction', original_action)
                    event.set('EventResult', 'NA')
                end

                # Severity mapping
                severity = (alert['severity'].to_i rescue 0)
                case severity
                when 1
                    event.set('EventSeverity', 'High')
                    event.set('ThreatRiskLevel', 75)
                when 2
                    event.set('EventSeverity', 'Medium')
                    event.set('ThreatRiskLevel', 50)
                when 3
                    event.set('EventSeverity', 'Low')
                    event.set('ThreatRiskLevel', 25)
                else
                    event.set('EventSeverity', 'Informational')
                    event.set('ThreatRiskLevel', 10)
                end
                event.set('ThreatOriginalRiskLevel', severity.to_s)

                # Threat fields from alert
                event.set('ThreatName', alert['signature']) if alert['signature']
                event.set('ThreatId', alert['signature_id'].to_s) if alert['signature_id']
                event.set('ThreatCategory', alert['category']) if alert['category']
                event.set('NetworkRuleName', alert['signature']) if alert['signature']
                event.set('NetworkRuleNumber', alert['signature_id'].to_i) if alert['signature_id']

                # Flow byte/packet counts
                flow = event.get('[flow]') || {}
                event.set('SrcBytes', flow['bytes_toserver']) if flow['bytes_toserver']
                event.set('DstBytes', flow['bytes_toclient']) if flow['bytes_toclient']
                event.set('SrcPackets', flow['pkts_toserver']) if flow['pkts_toserver']
                event.set('DstPackets', flow['pkts_toclient']) if flow['pkts_toclient']
            "
        }

        mutate {
            id => "suricata-azure-cleanup"
            remove_field => ["message", "suricataData", "gw_hostname", "host", "port", "type", "event"]
        }

        mutate {
            id => "suricata-asim-int-coerce"
            convert => {
                "EventCount" => "integer"
                "SrcPortNumber" => "integer"
                "DstPortNumber" => "integer"
                "NetworkRuleNumber" => "integer"
                "ThreatRiskLevel" => "integer"
                "SrcBytes" => "integer"
                "DstBytes" => "integer"
                "SrcPackets" => "integer"
                "DstPackets" => "integer"
            }
        }
    }
}

# L4 Microseg → ASIM NetworkSession
filter {
    if "microseg" in [tags] and "mitm" not in [tags] {
        # ASIM common fields
        mutate {
            id => "microseg-asim-common"
            add_field => {
                "EventVendor" => "Aviatrix"
                "EventProduct" => "Distributed Cloud Firewall"
                "EventSchema" => "NetworkSession"
                "EventSchemaVersion" => "0.2.7"
                "EventType" => "NetworkSession"
                "EventCount" => 1
            }
        }

        # ASIM field mapping via Ruby
        ruby {
            id => "microseg-asim-mapping"
            code => "
                event.set('TimeGenerated', event.get('@timestamp'))
                event.set('EventStartTime', event.get('@timestamp'))
                event.set('EventEndTime', event.get('@timestamp'))

                # Network addressing
                event.set('SrcIpAddr', event.get('src_ip')) if event.get('src_ip')
                event.set('DstIpAddr', event.get('dst_ip')) if event.get('dst_ip')
                event.set('SrcPortNumber', event.get('src_port')) if event.get('src_port')
                event.set('DstPortNumber', event.get('dst_port')) if event.get('dst_port')
                event.set('NetworkProtocol', event.get('proto')) if event.get('proto')
                event.set('SrcMacAddr', event.get('src_mac')) if event.get('src_mac')
                event.set('DstMacAddr', event.get('dst_mac')) if event.get('dst_mac')

                # Device fields
                event.set('DvcHostname', event.get('gw_hostname')) if event.get('gw_hostname')
                event.set('DvcIpAddr', event.get('gw_ip')) if event.get('gw_ip')

                # Rule/session fields
                event.set('NetworkRuleName', event.get('uuid')) if event.get('uuid')
                event.set('NetworkSessionId', event.get('session_id').to_s) if event.get('session_id')
                event.set('NetworkBytes', event.get('session_byte_cnt')) if event.get('session_byte_cnt')
                event.set('NetworkPackets', event.get('session_pkt_cnt')) if event.get('session_pkt_cnt')

                # Session duration: convert nanoseconds to milliseconds
                if event.get('session_dur')
                    dur_ns = event.get('session_dur').to_i
                    event.set('NetworkDuration', dur_ns / 1_000_000)
                end

                # Session event subtype: 0=Start, else End
                if event.get('session_event')
                    se = event.get('session_event').to_i
                    event.set('EventSubType', se == 0 ? 'Start' : 'End')
                end

                # DvcAction mapping
                action = event.get('action').to_s.upcase rescue ''
                event.set('DvcOriginalAction', event.get('action').to_s)
                case action
                when 'PERMIT'
                    event.set('DvcAction', 'Allow')
                    event.set('EventResult', 'Success')
                    event.set('EventSeverity', 'Informational')
                when 'DENY'
                    event.set('DvcAction', 'Deny')
                    event.set('EventResult', 'Failure')
                    event.set('EventSeverity', 'Low')
                else
                    event.set('DvcAction', event.get('action').to_s)
                    event.set('EventResult', 'NA')
                    event.set('EventSeverity', 'Informational')
                end
            "
        }

        mutate {
            id => "microseg-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri", "data_hex"]
        }

        mutate {
            id => "microseg-asim-int-coerce"
            convert => {
                "EventCount" => "integer"
                "SrcPortNumber" => "integer"
                "DstPortNumber" => "integer"
                "NetworkBytes" => "integer"
                "NetworkDuration" => "integer"
                "NetworkPackets" => "integer"
            }
        }
    }
}

# L7 MITM/DCF → ASIM WebSession
filter {
    if "mitm" in [tags] {
        # ASIM common fields
        mutate {
            id => "mitm-asim-common"
            add_field => {
                "EventVendor" => "Aviatrix"
                "EventProduct" => "Distributed Cloud Firewall"
                "EventSchema" => "WebSession"
                "EventSchemaVersion" => "0.2.7"
                "EventType" => "HTTPsession"
                "EventCount" => 1
            }
        }

        # ASIM field mapping via Ruby
        ruby {
            id => "mitm-asim-mapping"
            code => "
                event.set('TimeGenerated', event.get('@timestamp'))
                event.set('EventStartTime', event.get('@timestamp'))
                event.set('EventEndTime', event.get('@timestamp'))

                # Network addressing
                event.set('SrcIpAddr', event.get('src_ip')) if event.get('src_ip')
                event.set('DstIpAddr', event.get('dst_ip')) if event.get('dst_ip')
                event.set('SrcPortNumber', event.get('src_port')) if event.get('src_port')
                event.set('DstPortNumber', event.get('dst_port')) if event.get('dst_port')
                event.set('NetworkProtocol', 'TCP')

                # TLS/HTTP fields
                event.set('DstFqdn', event.get('mitm_sni_hostname')) if event.get('mitm_sni_hostname')
                event.set('DstHostname', event.get('mitm_sni_hostname')) if event.get('mitm_sni_hostname')
                event.set('Url', event.get('mitm_url_parts')) if event.get('mitm_url_parts')

                # Device fields
                event.set('DvcHostname', event.get('gw_hostname')) if event.get('gw_hostname')
                event.set('DvcIpAddr', event.get('gw_ip')) if event.get('gw_ip')

                # Rule
                event.set('NetworkRuleName', event.get('uuid')) if event.get('uuid')

                # DvcAction mapping (MITM uses Permit/DENY/DROP)
                action = event.get('action').to_s
                event.set('DvcOriginalAction', action)
                case action.downcase
                when 'permit'
                    event.set('DvcAction', 'Allow')
                    event.set('EventResult', 'Success')
                    event.set('EventSeverity', 'Informational')
                when 'deny', 'drop'
                    event.set('DvcAction', 'Deny')
                    event.set('EventResult', 'Failure')
                    event.set('EventSeverity', 'Low')
                else
                    event.set('DvcAction', action)
                    event.set('EventResult', 'NA')
                    event.set('EventSeverity', 'Informational')
                end
            "
        }

        mutate {
            id => "mitm-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }

        mutate {
            id => "mitm-asim-int-coerce"
            convert => {
                "EventCount" => "integer"
                "SrcPortNumber" => "integer"
                "DstPortNumber" => "integer"
            }
        }
    }
}

# =============================================================================
# Non-security log types — pre-processing (unchanged)
# =============================================================================

# Gateway Network Stats pre-processing for Azure
filter {
    if "gw_net_stats" in [tags] {
        ruby {
            id => "gw-net-stats-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "gw-net-stats-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

# Gateway System Stats pre-processing for Azure
filter {
    if "gw_sys_stats" in [tags] {
        ruby {
            id => "gw-sys-stats-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "gw-sys-stats-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri", "cpu_cores"]
        }
    }
}

# Controller CMD/API pre-processing for Azure
filter {
    if "cmd" in [tags] {
        ruby {
            id => "cmd-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "cmd-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

# Tunnel Status pre-processing for Azure
filter {
    if "tunnel_status" in [tags] {
        ruby {
            id => "tunnel-status-azure-timegen"
            code => "event.set('TimeGenerated', event.get('@timestamp'))"
        }

        mutate {
            id => "tunnel-status-azure-cleanup"
            remove_field => ["message", "host", "port", "type", "event", "@version", "syslog_pri"]
        }
    }
}

output {
    # Suricata IDS events → AviatrixIDS_CL (ASIM NetworkSession)
    if "suricata" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "security") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-suricata"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_ids_id}"
            dcr_stream_name => "${azure_stream_ids}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L7 DCF / MITM events → AviatrixWebSession_CL (ASIM WebSession)
    else if "mitm" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "security") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-mitm"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_websession_id}"
            dcr_stream_name => "${azure_stream_websession}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # L4 Microseg events → AviatrixNetworkSession_CL (ASIM NetworkSession)
    else if "microseg" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "security") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-microseg"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_netsession_id}"
            dcr_stream_name => "${azure_stream_netsession}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Gateway Network Stats → AviatrixGwNetStats_CL
    else if "gw_net_stats" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "networking") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-gw-net-stats"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_gw_net_stats_id}"
            dcr_stream_name => "${azure_stream_gw_net_stats}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Gateway System Stats → AviatrixGwSysStats_CL
    else if "gw_sys_stats" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "networking") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-gw-sys-stats"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_gw_sys_stats_id}"
            dcr_stream_name => "${azure_stream_gw_sys_stats}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Controller CMD/API events → AviatrixCmd_CL
    else if "cmd" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "security") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-cmd"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_cmd_id}"
            dcr_stream_name => "${azure_stream_cmd}"
            azure_cloud => "${azure_cloud}"
        }
    }

    # Tunnel Status events → AviatrixTunnelStatus_CL
    else if "tunnel_status" in [tags] and ("${LOG_PROFILE:all}" == "all" or "${LOG_PROFILE:all}" == "networking") {
        microsoft-sentinel-log-analytics-logstash-output-plugin {
            id => "azure-tunnel-status"
            client_app_Id => "${client_app_id}"
            client_app_secret => "${client_app_secret}"
            tenant_id => "${tenant_id}"
            data_collection_endpoint => "${data_collection_endpoint}"
            dcr_immutable_id => "${azure_dcr_tunnel_status_id}"
            dcr_stream_name => "${azure_stream_tunnel_status}"
            azure_cloud => "${azure_cloud}"
        }
    }
}
