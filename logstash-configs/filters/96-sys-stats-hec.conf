# System Stats HEC Payload Builder
# Builds Splunk HEC payload for gw_sys_stats events (same pattern as suricata)
# Uses format => "message" so cpu_cores_parsed serializes as a proper JSON array
#
# Runs after 90-timestamp.conf (unix_time) and 95-field-conversion.conf (type coercions)

filter {
    if "gw_sys_stats" in [tags] {
        ruby {
            id => "sys-stats-hec-payload"
            code => '
                require "json"

                event_data = {
                    "gateway" => event.get("gateway"),
                    "alias" => event.get("alias"),
                    "cpu_idle" => event.get("cpu_idle"),
                    "memory_free" => event.get("memory_free"),
                    "memory_available" => event.get("memory_available"),
                    "memory_total" => event.get("memory_total"),
                    "disk_total" => event.get("disk_total"),
                    "disk_free" => event.get("disk_free"),
                    "syslog" => event.get("message")
                }

                # Add cpu_cores fields only if they exist (gateway events, not controller)
                cpu_busy = event.get("cpu_busy")
                event_data["cpu_busy"] = cpu_busy if cpu_busy

                cpu_core_count = event.get("cpu_core_count")
                event_data["cpu_core_count"] = cpu_core_count if cpu_core_count

                cpu_cores_parsed = event.get("cpu_cores_parsed")
                event_data["cpu_cores_parsed"] = cpu_cores_parsed if cpu_cores_parsed

                cpu_cores_raw = event.get("cpu_cores")
                event_data["cpu_cores_raw"] = cpu_cores_raw if cpu_cores_raw

                agg_min = event.get("cpu_aggregate_busy_min")
                event_data["cpu_aggregate_busy_min"] = agg_min if agg_min

                agg_max = event.get("cpu_aggregate_busy_max")
                event_data["cpu_aggregate_busy_max"] = agg_max if agg_max

                agg_avg = event.get("cpu_aggregate_busy_avg")
                event_data["cpu_aggregate_busy_avg"] = agg_avg if agg_avg

                # Remove nil values
                event_data.delete_if { |_k, v| v.nil? }

                payload = {
                    "sourcetype" => "aviatrix:gateway:system",
                    "source" => "avx-gw-sys-stats",
                    "host" => event.get("gateway"),
                    "time" => event.get("unix_time"),
                    "event" => event_data
                }

                event.set("[@metadata][sys_stats_hec_payload]", payload.to_json)
            '
        }
    }
}
