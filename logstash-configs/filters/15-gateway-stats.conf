# Gateway Performance Statistics Filter
# Parses AviatrixGwNetStats and AviatrixGwSysStats syslog messages

# Network statistics (interface throughput)
filter {
    if [type] == "syslog" and !("fqdn" in [tags] or "cmd" in [tags] or "microseg" in [tags] or "mitm" in [tags] or "suricata" in [tags]) {
        grok {
            id => "gw_net_stats"
            patterns_dir => ["/usr/share/logstash/patterns"]
            add_tag => ["gw_net_stats"]
            tag_on_failure => []
            break_on_match => true
            match => {
                "message" => [
                    # With syslog priority prefix and public_ip
                    "<%{NUMBER:syslog_pri}>%{SYSLOG_TIMESTAMP:date}%{DATA}AviatrixGwNetStats:%{DATA}name=%{NOTSPACE:gateway}(?:%{DATA}alias=%{NOTSPACE:alias})?(?:%{DATA}public_ip=%{IP:public_ip})?%{DATA}private_ip=%{IP:private_ip}%{DATA}interface=%{NOTSPACE:interface}%{DATA}total_rx_rate=%{NOTSPACE:total_rx_rate}%{DATA}total_tx_rate=%{NOTSPACE:total_tx_rate}%{DATA}total_rx_tx_rate=%{NOTSPACE:total_rx_tx_rate}%{DATA}total_rx_cum=%{NOTSPACE:total_rx_cum}%{DATA}total_tx_cum=%{NOTSPACE:total_tx_cum}%{DATA}total_rx_tx_cum=%{NOTSPACE:total_rx_tx_cum}(?:%{DATA}conntrack_limit_exceeded=%{NUMBER:conntrack_limit_exceeded})?(?:%{DATA}bw_in_limit_exceeded=%{NUMBER:bw_in_limit_exceeded})?(?:%{DATA}bw_out_limit_exceeded=%{NUMBER:bw_out_limit_exceeded})?(?:%{DATA}pps_limit_exceeded=%{NUMBER:pps_limit_exceeded})?(?:%{DATA}linklocal_limit_exceeded=%{NUMBER:linklocal_limit_exceeded})?(?:%{DATA}conntrack_count=%{NUMBER:conntrack_count})?(?:%{DATA}conntrack_allowance_available=%{NUMBER:conntrack_allowance_available})?(?:%{DATA}conntrack_usage_rate=%{NUMBER:conntrack_usage_rate})?"
                ]
            }
        }
    }
}

# System statistics (CPU, memory, disk)
filter {
    if [type] == "syslog" and !("fqdn" in [tags] or "cmd" in [tags] or "microseg" in [tags] or "mitm" in [tags] or "suricata" in [tags] or "gw_net_stats" in [tags]) {
        grok {
            id => "gw_sys_stats"
            patterns_dir => ["/usr/share/logstash/patterns"]
            add_tag => ["gw_sys_stats"]
            tag_on_failure => []
            break_on_match => true
            match => {
                "message" => [
                    "<%{NUMBER:syslog_pri}>%{SYSLOG_TIMESTAMP:date}%{DATA}AviatrixGwSysStats:%{DATA}name=%{NOTSPACE:gateway}(?:%{DATA}alias=%{NOTSPACE:alias})?%{DATA}cpu_idle=%{NUMBER:cpu_idle}%{DATA}memory_free=%{NUMBER:memory_free}%{DATA}memory_available=%{NUMBER:memory_available}%{DATA}memory_total=%{NUMBER:memory_total}%{DATA}disk_total=%{NUMBER:disk_total}%{DATA}disk_free=%{NUMBER:disk_free}(?:%{DATA}cpu_cores=%{GREEDYDATA:cpu_cores})?"
                ]
            }
        }
    }
}
