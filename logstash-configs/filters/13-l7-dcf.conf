# L7 DCF / MITM (TLS Inspection) Filter
# Parses traffic_server JSON syslog messages and converts to microseg format
# Also creates cloned FQDN events for URL/hostname tracking

filter {
    if [type] == "syslog" and !("fqdn" in [tags] or "cmd" in [tags] or "microseg" in [tags]) {
        grok {
            id => "mitm"
            patterns_dir => ["/usr/share/logstash/patterns"]
            break_on_match => true
            add_tag => ["mitm"]
            remove_tag => ["_grokparsefailure"]
            match => {
                "message" => [
                    # traffic_server JSON format with syslog priority
                    "<%{NUMBER:syslog_pri}>%{SYSLOG_TIMESTAMP:date} +GW-%{DATA:gw_hostname}-%{IP}%{DATA}traffic_server\[%{NUMBER}\]: %{GREEDYDATA:[@metadata][json_payload]}"
                ]
            }
            remove_field => ["event", "@version", "type", "host"]
        }

        # Parse JSON payload
        if "mitm" in [tags] {
            json {
                id => "mitm-json"
                skip_on_invalid_json => true
                source => "[@metadata][json_payload]"
                target => "[@metadata][payload]"
            }
        }

        # Convert MITM to microseg format
        if "mitm" in [tags] and [@metadata][payload] and "_jsonparsefailure" not in [tags] {
            # Use timestamp provided by MITM instead of syslog timestamp
            date {
                id => "mitm-timestamp"
                match => [ "[@metadata][payload][timestamp]", "UNIX" ]
                target => "@timestamp"
                remove_field => "date"
            }

            # Map MITM fields to microseg fields
            mutate {
                id => "mitm-map-to-microseg"
                add_field => {
                    "proto" => "TCP"
                    "action" => "%{[@metadata][payload][action]}"
                    "src_ip" => "%{[@metadata][payload][src]}"
                    "src_port" => "%{[@metadata][payload][src_port]}"
                    "dst_ip" => "%{[@metadata][payload][dest]}"
                    "dst_port" => "%{[@metadata][payload][dest_port]}"
                    "enforced" => "%{[@metadata][payload][enforced]}"
                    "uuid" => "%{[@metadata][payload][decided_by]}"
                    "mitm_sni_hostname" => "%{[@metadata][payload][sni_hostname]}"
                }
            }

            # Normalize DROP action to DENY
            if [@metadata][payload][action] == "DROP" {
                mutate {
                    id => "mitm-map-drop-to-deny"
                    replace => {
                        "[@metadata][payload][action]" => "DENY"
                    }
                }
            }

            # Add URL if present
            if [@metadata][payload][url] {
                mutate {
                    id => "mitm-url-parts"
                    add_field => {
                        "mitm_url_parts" => "%{[@metadata][payload][url]}"
                    }
                }
            }

            # Add decrypted_by if present
            if [@metadata][payload][decrypted_by] {
                mutate {
                    id => "mitm-decrypted-by"
                    add_field => {
                        "mitm_decrypted_by" => "%{[@metadata][payload][decrypted_by]}"
                    }
                }
            }

            # Add the microseg tag for output routing
            mutate {
                id => "mitm-add-microseg-tag"
                add_tag => ["microseg"]
            }

            # Clone event for FQDN tracking
            clone {
                clones => ["fqdn"]
                add_tag => ["fqdn"]
            }
        }
    }
}

# Transform cloned MITM events into FQDN format
filter {
    if "fqdn" in [tags] and "mitm" in [tags] and "microseg" in [tags] {
        if [@metadata][payload][url] {
            mutate {
                id => "fqdn-mitm-add-url"
                add_field => {
                    "url" => "%{[@metadata][payload][url]}"
                }
            }
        }

        # Map MITM microseg fields to FQDN fields
        mutate {
            id => "fqdn-mitm-map-to-fqdn"
            add_field => {
                "sip" => "%{[@metadata][payload][src]}"
                "dip" => "%{[@metadata][payload][dest]}"
                "gateway" => "%{[gw_hostname]}"
                "state" => "MATCHED"
                "hostname" => "%{[@metadata][payload][sni_hostname]}"
                "rule" => "%{[@metadata][payload][sni_hostname]};%{[@metadata][payload][dest_port]}"
            }
            remove_tag => ["microseg", "mitm"]
            remove_field => ["mitm_url_parts", "mitm_decrypted_by", "mitm_sni_hostname", "src_ip", "src_port", "dst_ip", "dst_port", "enforced", "gw_hostname"]
        }
    }
}
